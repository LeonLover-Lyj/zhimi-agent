# 知觅Agent手动测试指南

## 一、启动应用

### 1.1 准备工作
1. 确保虚拟环境已创建并激活
2. 确保已配置 `.env` 文件，包含 `DASHSCOPE_API_KEY`
3. 确保已构建知识库索引（运行 `python scripts/index_local_docs.py --dir data`）

### 1.2 启动应用
```bash
# Windows
run.bat

# Linux/Mac
./run.sh
```

### 1.3 验证启动
- [ ] 浏览器自动打开或显示本地URL（通常是 http://localhost:8501）
- [ ] 页面标题显示 "🌿 知觅 – Qwen + 本地知识库"
- [ ] 侧边栏显示 "📊 对话统计"
- [ ] 输入框显示提示 "例如：知觅支持哪些功能？"

---

## 二、测试用例清单

### 2.1 多轮对话测试

#### 用例1：连续3轮对话，验证上下文保持
**步骤：**
1. 输入："知觅是什么？"
2. 等待回复后，输入："它支持哪些功能？"
3. 等待回复后，输入："如何安装？"

**预期结果：**
- [ ] Agent能理解"它"指代"知觅"
- [ ] Agent能基于之前的对话上下文回答
- [ ] 回答连贯，不重复之前已说明的信息

**验证点：**
- 侧边栏显示总对话轮数正确递增
- 对话历史正确显示

---

#### 用例2：超过3轮对话，验证只使用最近3轮
**步骤：**
1. 进行5轮对话：
   - "知觅是什么？"
   - "它支持哪些功能？"
   - "如何安装？"
   - "配置文件在哪里？"
   - "之前提到的功能有哪些？"（引用第2轮的内容）

**预期结果：**
- [ ] Agent能回答关于"之前提到的功能"的问题
- [ ] 侧边栏显示总对话轮数为5
- [ ] Agent主要参考最近3轮上下文

**验证点：**
- 对话统计信息正确显示
- Agent的回答表明它记得最近几轮的内容

---

#### 用例3：引用之前对话内容
**步骤：**
1. 第一轮："知觅支持哪些功能？"
2. 第二轮："刚才提到的第一个功能是什么？"

**预期结果：**
- [ ] Agent能理解"刚才提到的第一个功能"
- [ ] Agent能准确引用第一轮对话中的内容

**验证点：**
- 回答中包含第一轮对话中提到的功能

---

### 2.2 搜索工具测试

#### 用例1：简单关键词查询
**测试场景：** 明确的关键词查询
**步骤：**
1. 输入："知觅是什么"
2. 输入："如何安装"
3. 输入："配置文件位置"

**预期结果：**
- [ ] Agent调用 `simple_keyword_search` 工具（可在verbose输出中看到）
- [ ] 返回相关文档内容
- [ ] 回答基于搜索结果

**验证点：**
- 控制台输出显示工具调用
- 回答内容来自本地文档

---

#### 用例2：语义查询
**测试场景：** 需要理解语义的问题
**步骤：**
1. 输入："解释一下知觅的工作原理"
2. 输入："它们之间的关系是什么"
3. 输入："这个概念如何应用"

**预期结果：**
- [ ] Agent调用 `hybrid_search` 工具
- [ ] 返回语义相关的文档内容
- [ ] 回答体现对语义的理解

**验证点：**
- 控制台输出显示使用了混合检索
- 回答不仅包含关键词匹配，还包含语义相关内容

---

#### 用例3：无索引时的防御式处理
**测试场景：** 删除或重命名索引目录
**步骤：**
1. 停止应用
2. 重命名 `memory/faiss_index` 目录（如改为 `memory/faiss_index_backup`）
3. 重新启动应用
4. 输入任何查询问题

**预期结果：**
- [ ] 应用正常启动，不崩溃
- [ ] 工具返回友好的提示："⚠️ 本地知识库尚未构建，请先构建索引。"
- [ ] Agent能正常回复，告知用户需要构建索引

**验证点：**
- 没有异常抛出
- 错误提示清晰明确

---

### 2.3 工具选择测试

#### 用例1：明确关键词查询应使用简单检索
**测试场景：** 具体术语、名称查询
**测试问题：**
- "知觅是什么"
- "如何安装知觅"
- "配置文件在哪里"

**预期结果：**
- [ ] Agent选择使用 `simple_keyword_search`
- [ ] 控制台显示工具调用信息

**验证点：**
- 查看控制台verbose输出，确认工具名称

---

#### 用例2：语义/概念查询应使用混合检索
**测试场景：** 需要理解含义的问题
**测试问题：**
- "解释一下工作原理"
- "它们之间的关系是什么"
- "这个概念如何应用"

**预期结果：**
- [ ] Agent选择使用 `hybrid_search`
- [ ] 控制台显示工具调用信息

**验证点：**
- 查看控制台verbose输出，确认工具名称

---

#### 用例3：闲聊问题不应调用工具
**测试场景：** 常识性问题、问候、闲聊
**测试问题：**
- "你好"
- "谢谢"
- "什么是Python"
- "如何计算1+1"

**预期结果：**
- [ ] Agent不调用任何工具
- [ ] Agent直接回答，不进行搜索
- [ ] 回答自然流畅

**验证点：**
- 控制台不显示工具调用
- 回答时间较短（无工具调用延迟）

---

### 2.4 UI功能测试

#### 用例1：验证对话统计信息显示
**步骤：**
1. 启动应用
2. 进行几轮对话

**预期结果：**
- [ ] 侧边栏显示"总对话轮数"
- [ ] 侧边栏显示"当前使用历史窗口：最近 3 轮"
- [ ] 对话轮数随对话进行正确递增

**验证点：**
- 统计信息实时更新
- 数字显示正确

---

#### 用例2：验证对话历史显示
**步骤：**
1. 进行多轮对话
2. 刷新页面（或重新打开应用）

**预期结果：**
- [ ] 对话历史正确显示在聊天界面
- [ ] 用户消息和助手消息正确区分
- [ ] 消息顺序正确

**验证点：**
- 界面布局正确
- 消息格式清晰

---

#### 用例3：验证错误处理显示
**测试场景：** 模拟错误情况
**步骤：**
1. 如果可能，临时断开网络或修改API key
2. 输入问题

**预期结果：**
- [ ] 错误信息友好显示
- [ ] 应用不崩溃
- [ ] 错误提示清晰

**验证点：**
- 错误处理优雅
- 用户能看到有用的错误信息

---

## 三、测试结果记录

### 测试环境
- 日期：___________
- 测试人员：___________
- Python版本：___________
- 操作系统：___________

### 测试结果

| 测试用例 | 状态 | 备注 |
|---------|------|------|
| 多轮对话-用例1 | ☐ 通过 ☐ 失败 | |
| 多轮对话-用例2 | ☐ 通过 ☐ 失败 | |
| 多轮对话-用例3 | ☐ 通过 ☐ 失败 | |
| 搜索工具-用例1 | ☐ 通过 ☐ 失败 | |
| 搜索工具-用例2 | ☐ 通过 ☐ 失败 | |
| 搜索工具-用例3 | ☐ 通过 ☐ 失败 | |
| 工具选择-用例1 | ☐ 通过 ☐ 失败 | |
| 工具选择-用例2 | ☐ 通过 ☐ 失败 | |
| 工具选择-用例3 | ☐ 通过 ☐ 失败 | |
| UI功能-用例1 | ☐ 通过 ☐ 失败 | |
| UI功能-用例2 | ☐ 通过 ☐ 失败 | |
| UI功能-用例3 | ☐ 通过 ☐ 失败 | |

### 发现的问题
1. 
2. 
3. 

---

## 四、问题排查指南

### 4.1 应用无法启动
- **检查虚拟环境**：确保已激活虚拟环境
- **检查依赖**：运行 `pip install -r requirements.txt`
- **检查端口**：确保8501端口未被占用

### 4.2 Agent无法回答
- **检查API Key**：确认 `.env` 文件中的 `DASHSCOPE_API_KEY` 正确
- **检查网络**：确认能访问DashScope API
- **查看日志**：检查控制台输出的错误信息

### 4.3 搜索工具不工作
- **检查索引**：确认 `memory/faiss_index` 目录存在
- **重建索引**：运行 `python scripts/index_local_docs.py --dir data`
- **检查文档**：确认 `data/` 目录下有文档文件

### 4.4 工具选择不正确
- **查看verbose输出**：检查Agent的决策过程
- **检查工具描述**：确认工具描述清晰明确
- **调整提示词**：可能需要优化系统消息中的工具选择规则

---

## 五、快速测试清单

快速验证核心功能的简化测试：

1. [ ] 启动应用成功
2. [ ] 能进行基本对话
3. [ ] 搜索工具能返回结果
4. [ ] 多轮对话保持上下文
5. [ ] UI显示正常
6. [ ] 错误处理友好

---

## 六、测试完成标准

所有核心功能测试通过的标准：
- ✅ 多轮对话功能正常，能保持最近2-3轮上下文
- ✅ 搜索工具正常工作（简单关键词检索和混合检索）
- ✅ Agent能自动选择合适的搜索工具
- ✅ Agent不会在闲聊/常识问题中调用工具
- ✅ UI界面正常显示和交互
- ✅ 错误处理友好，应用稳定

